# Collada-Based Serializers

## Overview

This project contains the following serializers: Collada (DAE), Google Earth (KMZ), and OpenGL Transmission Format (glTF). The Collada format is the primary goal of the serializers in this package. It is used to generate Collada 3d model files with the extension of "DAE". The KMZ and glTF formats provide smaller serializers that build on the result of the Collada serializer. For KMZ, the output is a KMZ file, which is a ZIP consisting of a KML file of XML and a Collada model file. For glTF, the output may be retrieved as a ZIP file or a JSON file. For glTF's output, these files contain in some form: a binary file (project-name.bin), a JSON file (project-name.json), a vertex shader GLSL (project-nameXVS.glsl), and a fragment shader GLSL (project-nameXFS.glsl). The glTF is dependent upon the program collada2gltf being available on the path of the server operating system of the BIMServer.


### Collada (DAE)

Collada files currently present each IfcProduct as its own set of geometry. One camera and one directional light are included. This serializer currently does not consider any texture data, but does provide colored materials in conjunction with the IfcProduct type (i.e. IfcWindow, IfcRoof, etc). If the IfcProduct provides a surface style, that is used in place of the default material. 


### Google Earth (KMZ)

KMZ files provide a placemark on planet Earth (where the IFC object would exist) and the geometry to display it. 


### OpenGL Transmission Format (glTF)

#### Dependencies

This serializer depends on the collada2gltf exporter. It must be available to be executed from the command-line. In the case of applicable operating systems (Windows & MacOSX), binary versions of the exporter are provided (V0.6). For convenience in updating just the exporter, the binaries are copied to a directory beneath BIMServer's "tmp" directory, so that the paths look like: __path-to-bim-server/home-directory/tmp/gltf__, __path-to-bim-server/home-directory/tmp/gltf/collada2gltf__, __path-to-bim-server/home-directory/tmp/gltf/collada2gltf.exe__

In the case of MacOSX, placing or replacing the generated "collada2gltf" file will update the plugin to the current version. In the case of Windows, placing or replacing the generated "collada2gltf.exe" file will update the plugin to the current version. For all other operating systems, it is necessary to build the exporter application. In these scenarios, the plugin expects the operating system to resolve the name "collada2gltf" and will not attempt to load any pre-packaged binaries. 

Download the exporter, view building instructions, stay up-to-date here: https://github.com/KhronosGroup/glTF/wiki/converter

#### Output Goals

This serializer wraps the set of files generated by the collada2gltf exporter. For example, the JSON version of the plugin results in something like the following for a project called "P1":

```javascript
{
	"P1.bin": "data:application/octet-stream;base64,AAABAAIAAgABA...AAAIA/",
	"P1.json": "data:application/json;base64,ew0KICAgICJhY2N...CAgIH0NCn0=",
	"P10FS.glsl": "data:text/plain;base64,cHJlY2lzaW9...sNCn0NCg==",
	"P10VS.glsl": "data:text/plain;base64,cHJlY2lzaW9u...M7DQp9DQo=",
}
```

The ZIP version of the plugin results in those same files (P1.bin, P1.json, P10FS.glsl, P10VS.glsl) being put into a ZIP file instead.

#### Multiple Pass Variation 

As a project may have a very large number of IfcProduct objects (more than 2000), it may be necessary to use the multiple pass variation of the plugin to get the desired result. This method is intentionally very slow, requiring the plugin to pass individual IfcProduct objects to the collada2gltf program, joining the output after each step. This method can be beneficial to debugging collada2gltf crashes. Things that are known to crash collada2gltf are: __(1)__ an invalid material name and __(2)__ a light defined in the Collada file but not used in any scene.

#### Open3DGC Compression

Some of the plugins that interface with the glTF serializer allow the serializer to inform the collada2gltf exporter to use geometry compression, resulting in a significantly smaller BIN file. However, that compression must be implemented by whatever is reading the geometry back at runtime.

#### Suggested Render States

To reliably show project geometry, it is suggested that at least the following render states be forced: __(1)__ material double-sidedness, __(2)__ material polygon offset, __(3)__ material polygon offset factor of around 1, and __(4)__ material polygon offset units of around 0.1.

In THREE.js, that might look like:
```javascript
rootObject.traverse(function(node) {
	if (node.material) {
		node.material.side = THREE.DoubleSide;
		node.material.polygonOffset = true;
		node.material.polygonOffsetFactor = 1;
		node.material.polygonOffsetUnits = 0.1;
	}
});
```

#### webGL Output Examples using THREE.js

1. __Building HVAC in webGL__: http://youtu.be/a3HDTCD4ilY
2. __Building structure in webGL__: http://youtu.be/MOk0TgGPrOY
3. __Duplex A accommodations__: http://youtu.be/gJ3J1jsKHUA
4. __Duplex A__: http://youtu.be/ndevVG8cOpY
5. __Two-Story building__: http://youtu.be/S2qzohGDzuw
6. __Pipes__: http://youtu.be/yS46pdTCoSc